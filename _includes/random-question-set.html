{% comment %}
This include file builds an interactive, random question set.
- file: The name of the data file (e.g., "simplifying-fractions")
- count: The number of random questions to select (e.g., 10)
{% endcomment %}

{% assign all_question_data = site.data[include.file] %}
{% assign no_js_random_questions = all_question_data | sample: include.count %}

<div id="random-quiz-container" class="quiz-container-js" data-quiz-count="{{ include.count }}">
  
  <!-- === ACCESSIBILITY FALLBACK (No JavaScript) === -->
  <noscript>
    <div class="no-js-warning">
      <p>This section works best with JavaScript enabled. Here are {{ include.count }} randomly selected questions for this session:</p>
    </div>
    <ol>
      {% for q in no_js_random_questions %}
        <li>
          <p>{{ q.question }}</p>
          <p><strong>Solution:</strong> {{ q.solution }}</p>
          <p><strong>Answer:</strong> {{ q.answer }}</p>
          <hr>
        </li>
      {% endfor %}
    </ol>
  </noscript>

  <!-- === INTERACTIVE QUIZ INTERFACE (Requires JavaScript) === -->
  <div class="quiz-ui" hidden>
    <div class="quiz-status" id="quiz-status"></div>
    
    <div class="quiz-question-area">
      <div id="quiz-question-text" class="question-text"></div>
      
      <div id="quiz-solution-area" class="solution-details" hidden>
        <div class="solution-content">
          <p id="quiz-solution-text"></p>
          <p><strong>Answer:</strong> <span id="quiz-answer-text"></span></p>
        </div>
      </div>
    </div>

    <div class="quiz-controls">
      <button id="btn-show-solution">Show Solution</button>
      <button id="btn-next-question" disabled>Next Question</button>
    </div>
  </div>

  <!-- === QUIZ FINISHED SCREEN === -->
  <div class="quiz-finished" id="quiz-finished-screen" hidden>
    <h2>Practice Complete!</h2>
    <p>You have completed all {{ include.count }} questions.</p>
    <button id="btn-start-over">Start Over with New Questions</button>
  </div>
</div>


<!-- === JAVASCRIPT LOGIC (Corrected) === -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // BUG FIX #2: Pass the ENTIRE dataset from Jekyll to JavaScript
    const allQuestions = {{ all_question_data | jsonify }};
    const totalQuestions = parseInt(document.getElementById('random-quiz-container').dataset.quizCount, 10);
    let questions = [];
    let currentIndex = 0;

    // Get references to all the HTML elements
    const quizUI = document.querySelector('.quiz-ui');
    const statusText = document.getElementById('quiz-status');
    const questionText = document.getElementById('quiz-question-text');
    const solutionArea = document.getElementById('quiz-solution-area');
    const solutionText = document.getElementById('quiz-solution-text');
    const answerText = document.getElementById('quiz-answer-text');
    const finishedScreen = document.getElementById('quiz-finished-screen');
    const btnShowSolution = document.getElementById('btn-show-solution');
    const btnNextQuestion = document.getElementById('btn-next-question');
    const btnStartOver = document.getElementById('btn-start-over');
    
    // NEW: Function to shuffle an array (Fisher-Yates algorithm)
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function initializeQuiz() {
      // BUG FIX #2: Shuffle and select questions on the client-side
      shuffleArray(allQuestions);
      questions = allQuestions.slice(0, totalQuestions);
      currentIndex = 0;

      quizUI.removeAttribute('hidden');
      finishedScreen.setAttribute('hidden', '');
      
      loadQuestion(currentIndex);
    }

    function loadQuestion(index) {
      if (index >= questions.length) {
        quizUI.setAttribute('hidden', '');
        finishedScreen.removeAttribute('hidden');
        return;
      }
      
      const currentQuestion = questions[index];
      
      statusText.textContent = `Question ${index + 1} of ${totalQuestions}`;
      questionText.innerHTML = currentQuestion.question;
      solutionText.innerHTML = currentQuestion.solution;
      answerText.innerHTML = currentQuestion.answer;
      
      // BUG FIX #1: Tell MathJax to re-render the new content
      if (window.MathJax) {
        MathJax.typesetPromise([questionText, solutionText, answerText]);
      }
      
      solutionArea.setAttribute('hidden', '');
      btnShowSolution.removeAttribute('disabled');
      btnNextQuestion.setAttribute('disabled', '');
    }

    function showSolution() {
      solutionArea.removeAttribute('hidden');
      btnShowSolution.setAttribute('disabled', '');
      btnNextQuestion.removeAttribute('disabled');
    }

    // Event Listeners
    btnShowSolution.addEventListener('click', showSolution);
    btnNextQuestion.addEventListener('click', () => {
      currentIndex++;
      loadQuestion(currentIndex);
    });
    btnStartOver.addEventListener('click', initializeQuiz);

    // Hide the No-JS content and start the interactive quiz
    document.querySelector('noscript')?.remove();
    initializeQuiz();
  });
</script>
